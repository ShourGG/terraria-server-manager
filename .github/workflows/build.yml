name: ğŸš€ Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: ğŸ”¨ Build Multi-Platform
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: ğŸ“¦ Install Frontend Dependencies
      working-directory: frontend
      run: npm ci
      
    - name: ğŸ”¨ Build Frontend (with Obfuscation)
      working-directory: frontend
      run: |
        npm run build
        # å‹ç¼©HTMLæ–‡ä»¶
        gzip -k dist/index.html
        # å‹ç¼©JSå’ŒCSSæ–‡ä»¶
        find dist/assets -name "*.js" -exec gzip -k {} \;
        find dist/assets -name "*.css" -exec gzip -k {} \;
        
    - name: ğŸ“ Copy Frontend to Dist
      run: |
        mkdir -p dist
        cp -r frontend/dist/* dist/
        
    - name: ğŸ”¨ Build Backend Binaries
      working-directory: backend
      run: |
        # å®‰è£…ä¾èµ–
        go mod tidy
        
        # æ„å»º Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ../release/terraria-panel-linux main.go
        
        # æ„å»º Windows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ../release/terraria-panel-windows.exe main.go
        
        # æ„å»º macOS AMD64
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ../release/terraria-panel-macos main.go
        
        # æ„å»º Linux ARM64
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ../release/terraria-panel-linux-arm64 main.go
        
    - name: ğŸ“¦ Create Release Packages
      run: |
        mkdir -p packages
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºå‘å¸ƒåŒ…
        platforms=("linux" "windows" "macos" "linux-arm64")
        
        for platform in "${platforms[@]}"; do
          echo "ğŸ“¦ æ‰“åŒ… $platform ç‰ˆæœ¬..."
          mkdir -p "terraria-panel-$platform"
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [ "$platform" = "windows" ]; then
            cp "release/terraria-panel-windows.exe" "terraria-panel-$platform/terraria-panel.exe"
            # åˆ›å»ºWindowså¯åŠ¨è„šæœ¬
            cat > "terraria-panel-$platform/start.bat" << 'EOF'
        @echo off
        echo ğŸ® å¯åŠ¨æ³°æ‹‰ç‘äºšæœåŠ¡å™¨ç®¡ç†é¢æ¿...
        terraria-panel.exe
        pause
        EOF
          else
            if [ "$platform" = "linux-arm64" ]; then
              cp "release/terraria-panel-linux-arm64" "terraria-panel-$platform/terraria-panel"
            else
              cp "release/terraria-panel-$platform" "terraria-panel-$platform/terraria-panel"
            fi
            chmod +x "terraria-panel-$platform/terraria-panel"
            # åˆ›å»ºLinux/macOSå¯åŠ¨è„šæœ¬
            cat > "terraria-panel-$platform/start.sh" << 'EOF'
        #!/bin/bash
        echo "ğŸ® å¯åŠ¨æ³°æ‹‰ç‘äºšæœåŠ¡å™¨ç®¡ç†é¢æ¿..."
        ./terraria-panel
        EOF
            chmod +x "terraria-panel-$platform/start.sh"
          fi
          
          # å¤åˆ¶å‰ç«¯æ–‡ä»¶
          cp -r dist "terraria-panel-$platform/"
          
          # å¤åˆ¶æ–‡æ¡£
          cp README.md "terraria-panel-$platform/"
          
          # åˆ›å»ºå‹ç¼©åŒ…
          if [ "$platform" = "windows" ]; then
            zip -r "packages/terraria-panel-$platform.zip" "terraria-panel-$platform/"
          else
            tar -czf "packages/terraria-panel-$platform.tar.gz" "terraria-panel-$platform/"
          fi
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "terraria-panel-$platform/"
        done
        
    - name: ğŸ“‹ Generate Checksums
      run: |
        cd packages
        sha256sum * > checksums.txt
        
    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          packages/*
          deploy.sh
          deploy.ps1
        body: |
          ## ğŸ® æ³°æ‹‰ç‘äºšæœåŠ¡å™¨ç®¡ç†é¢æ¿ ${{ github.ref_name }}
          
          ### âœ¨ æ–°åŠŸèƒ½
          - è‡ªåŠ¨ä¸‹è½½å®˜æ–¹æ³°æ‹‰ç‘äºšæœåŠ¡å™¨æ–‡ä»¶
          - è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/macOSï¼‰
          - å®æ—¶æœåŠ¡å™¨ç›‘æ§
          - ç°ä»£åŒ–Webç•Œé¢
          
          ### ğŸ“¥ å¿«é€Ÿå®‰è£…
          
          **Linux/macOS:**
          ```bash
          curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/deploy.sh | bash
          ```
          
          **Windows (PowerShell):**
          ```powershell
          iwr -useb https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/deploy.ps1 | iex
          ```
          
          ### ğŸ“¦ æ‰‹åŠ¨ä¸‹è½½
          - **Linux AMD64**: terraria-panel-linux.tar.gz
          - **Linux ARM64**: terraria-panel-linux-arm64.tar.gz  
          - **Windows**: terraria-panel-windows.zip
          - **macOS**: terraria-panel-macos.tar.gz
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ### ğŸ“š ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `start.sh` (Linux/macOS) æˆ– `start.bat` (Windows)
          4. æµè§ˆå™¨è®¿é—® http://localhost:8090
          
          ---
          
          **å®Œæ•´æ–‡æ¡£**: https://github.com/${{ github.repository }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
